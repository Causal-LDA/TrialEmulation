<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>A wrapper function to perform data preparation and model fitting in a sequence of emulated target trials — initiators • TrialEmulation</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="A wrapper function to perform data preparation and model fitting in a sequence of emulated target trials — initiators"><meta name="description" content=""><meta property="og:description" content=""><meta property="og:image" content="https://causal-lda.github.io/TrialEmulation/logo.svg"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">TrialEmulation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.4.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Getting-Started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/new-interface.html">New Interface</a></li>
    <li><a class="dropdown-item" href="../articles/Extending-TrialEmulation.html">Extending TrialEmulation</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://github.com/Causal-LDA/TrialEmulation/" aria-label="github"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>A wrapper function to perform data preparation and model fitting in a sequence of emulated target trials</h1>
      <small class="dont-index">Source: <a href="https://github.com/Causal-LDA/TrialEmulation/blob/main/R/initiators.R" class="external-link"><code>R/initiators.R</code></a></small>
      <div class="d-none name"><code>initiators.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><a href="https://lifecycle.r-lib.org/articles/stages.html#stable" class="external-link"><img src="figures/lifecycle-stable.svg" alt="[Stable]"></a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">initiators</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  id <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  period <span class="op">=</span> <span class="st">"period"</span>,</span>
<span>  treatment <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>  outcome <span class="op">=</span> <span class="st">"outcome"</span>,</span>
<span>  eligible <span class="op">=</span> <span class="st">"eligible"</span>,</span>
<span>  outcome_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  estimand_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ITT"</span>, <span class="st">"PP"</span>, <span class="st">"As-Treated"</span><span class="op">)</span>,</span>
<span>  model_var <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  switch_n_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  switch_d_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  first_period <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  last_period <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  first_followup <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  last_followup <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  use_censor_weights <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  save_weight_models <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  analysis_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"asis"</span>, <span class="st">"unweighted"</span>, <span class="st">"p99"</span>, <span class="st">"weight_limits"</span><span class="op">)</span>,</span>
<span>  weight_limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="cn">Inf</span><span class="op">)</span>,</span>
<span>  cense <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  pool_cense <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="st">"both"</span>, <span class="st">"numerator"</span><span class="op">)</span>,</span>
<span>  cense_d_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  cense_n_cov <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>,</span>
<span>  include_followup_time <span class="op">=</span> <span class="op">~</span><span class="va">followup_time</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">followup_time</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  include_trial_period <span class="op">=</span> <span class="op">~</span><span class="va">trial_period</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">trial_period</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  eligible_wts_0 <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  eligible_wts_1 <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  where_var <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  where_case <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>  <span class="va">data_dir</span>,</span>
<span>  glm_function <span class="op">=</span> <span class="st">"glm"</span>,</span>
<span>  quiet <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>A <code>data.frame</code> containing all the required variables in the person-time format, i.e., the  `long' format.</p></dd>


<dt id="arg-id">id<a class="anchor" aria-label="anchor" href="#arg-id"></a></dt>
<dd><p>Name of the variable for identifiers of the individuals.  Default is `id'.</p></dd>


<dt id="arg-period">period<a class="anchor" aria-label="anchor" href="#arg-period"></a></dt>
<dd><p>Name of the variable for the visit/period.   Default is `period'.</p></dd>


<dt id="arg-treatment">treatment<a class="anchor" aria-label="anchor" href="#arg-treatment"></a></dt>
<dd><p>Name of the variable  for the treatment indicator at that visit/period. Default is `treatment'.</p></dd>


<dt id="arg-outcome">outcome<a class="anchor" aria-label="anchor" href="#arg-outcome"></a></dt>
<dd><p>Name of the variable for the indicator of the outcome event at that visit/period.  Default is
`outcome'.</p></dd>


<dt id="arg-eligible">eligible<a class="anchor" aria-label="anchor" href="#arg-eligible"></a></dt>
<dd><p>Name of the variable for the indicator of eligibility for the target trial at that visit/period.
Default is `eligible'.</p></dd>


<dt id="arg-outcome-cov">outcome_cov<a class="anchor" aria-label="anchor" href="#arg-outcome-cov"></a></dt>
<dd><p>A RHS formula with baseline covariates to be adjusted for in the marginal structural model for the
emulated trials. Note that if a time-varying covariate is specified in <code>outcome_cov</code>, only its value at each of the
trial baselines will be included in the expanded data.</p></dd>


<dt id="arg-estimand-type">estimand_type<a class="anchor" aria-label="anchor" href="#arg-estimand-type"></a></dt>
<dd><p>Specify the estimand for the causal analyses in the sequence of emulated trials. <code>estimand_type = "ITT"</code> will perform intention-to-treat analyses, where treatment switching after trial baselines are ignored.
<code>estimand_type = "PP"</code> will perform per-protocol analyses, where individuals' follow-ups are artificially censored
and inverse probability of treatment weighting is applied. <code>estimand_type = "As-Treated"</code> will fit a standard
marginal structural model for all possible treatment sequences, where individuals' follow-ups are not artificially
censored  but treatment switching after trial baselines are accounted for by applying inverse probability of
treatment weighting.</p></dd>


<dt id="arg-model-var">model_var<a class="anchor" aria-label="anchor" href="#arg-model-var"></a></dt>
<dd><p>Treatment variables to be included in the marginal structural model for the emulated trials.
<code>model_var = "assigned_treatment"</code> will create a variable <code>assigned_treatment</code> that is the assigned treatment at
the trial baseline, typically used for ITT and per-protocol analyses. <code>model_var = "dose"</code> will create a variable
<code>dose</code> that is the cumulative number of  treatments received since the trial baseline, typically used in as-treated
analyses.</p></dd>


<dt id="arg-switch-n-cov">switch_n_cov<a class="anchor" aria-label="anchor" href="#arg-switch-n-cov"></a></dt>
<dd><p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of treatment weights. A derived variable named <code>time_on_regime</code> containing the duration of time that
the individual has been on the current treatment/non-treatment is available for use in these models.</p></dd>


<dt id="arg-switch-d-cov">switch_d_cov<a class="anchor" aria-label="anchor" href="#arg-switch-d-cov"></a></dt>
<dd><p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of treatment weights.</p></dd>


<dt id="arg-first-period">first_period<a class="anchor" aria-label="anchor" href="#arg-first-period"></a></dt>
<dd><p>First time period to be set as trial baseline  to start expanding the data.</p></dd>


<dt id="arg-last-period">last_period<a class="anchor" aria-label="anchor" href="#arg-last-period"></a></dt>
<dd><p>Last time period to be set as trial baseline  to start expanding the data.</p></dd>


<dt id="arg-first-followup">first_followup<a class="anchor" aria-label="anchor" href="#arg-first-followup"></a></dt>
<dd><p>First follow-up time/visit in the trials to be included in the marginal structural model for
the outcome event.</p></dd>


<dt id="arg-last-followup">last_followup<a class="anchor" aria-label="anchor" href="#arg-last-followup"></a></dt>
<dd><p>Last follow-up time/visit in the trials to be included in the marginal structural model for the
outcome event.</p></dd>


<dt id="arg-use-censor-weights">use_censor_weights<a class="anchor" aria-label="anchor" href="#arg-use-censor-weights"></a></dt>
<dd><p>Require the inverse probability of censoring weights. If <code>use_censor_weights = TRUE</code>, then
the variable name of the censoring indicator needs to be provided in the argument <code>cense</code>.</p></dd>


<dt id="arg-save-weight-models">save_weight_models<a class="anchor" aria-label="anchor" href="#arg-save-weight-models"></a></dt>
<dd><p>Save model objects for estimating the weights in <code>data_dir</code>.</p></dd>


<dt id="arg-analysis-weights">analysis_weights<a class="anchor" aria-label="anchor" href="#arg-analysis-weights"></a></dt>
<dd><p>Choose which type of weights to be used for fitting the marginal structural model for the
outcome event.</p><ul><li><p><code>"asis"</code>: use the weights as calculated.</p></li>
<li><p><code>"p99"</code>: use weights truncated at the 1st and 99th percentiles (based on the distribution of weights
in the entire sample).</p></li>
<li><p><code>"weight_limits"</code>: use weights truncated at the values specified in <code>weight_limits</code>.</p></li>
<li><p><code>"unweighted"</code>: set all analysis weights to 1, even if treatment weights or censoring weights were calculated.</p></li>
</ul></dd>


<dt id="arg-weight-limits">weight_limits<a class="anchor" aria-label="anchor" href="#arg-weight-limits"></a></dt>
<dd><p>Lower and upper limits to truncate weights, given as <code>c(lower, upper)</code></p></dd>


<dt id="arg-cense">cense<a class="anchor" aria-label="anchor" href="#arg-cense"></a></dt>
<dd><p>Variable name for the censoring indicator. Required if <code>use_censor_weights = TRUE</code>.</p></dd>


<dt id="arg-pool-cense">pool_cense<a class="anchor" aria-label="anchor" href="#arg-pool-cense"></a></dt>
<dd><p>Fit pooled or separate censoring models for those treated and those untreated at the immediately
previous visit. Pooling can be specified for the models for the numerator and denominator terms of the inverse
probability of censoring weights. One of <code>"none"</code>, <code>"numerator"</code>, or <code>"both"</code> (default is <code>"none"</code> except when
<code>estimand_type = "ITT"</code> then default is <code>"numerator"</code>).</p></dd>


<dt id="arg-cense-d-cov">cense_d_cov<a class="anchor" aria-label="anchor" href="#arg-cense-d-cov"></a></dt>
<dd><p>A RHS formula to specify the logistic models for estimating the denominator terms of the inverse
probability of censoring weights.</p></dd>


<dt id="arg-cense-n-cov">cense_n_cov<a class="anchor" aria-label="anchor" href="#arg-cense-n-cov"></a></dt>
<dd><p>A RHS formula to specify the logistic models for estimating the numerator terms of the inverse
probability of censoring weights.</p></dd>


<dt id="arg-include-followup-time">include_followup_time<a class="anchor" aria-label="anchor" href="#arg-include-followup-time"></a></dt>
<dd><p>The model to include the follow up time/visit of the trial (<code>followup_time</code>) in the
marginal structural model, specified as a RHS formula.</p></dd>


<dt id="arg-include-trial-period">include_trial_period<a class="anchor" aria-label="anchor" href="#arg-include-trial-period"></a></dt>
<dd><p>The model to include the trial period (<code>trial_period</code>) in the marginal structural model,
specified as a RHS formula.</p></dd>


<dt id="arg-eligible-wts-">eligible_wts_0<a class="anchor" aria-label="anchor" href="#arg-eligible-wts-"></a></dt>
<dd><p>See definition for <code>eligible_wts_1</code></p></dd>


<dt id="arg-eligible-wts-">eligible_wts_1<a class="anchor" aria-label="anchor" href="#arg-eligible-wts-"></a></dt>
<dd><p>Exclude some observations when fitting the models for the inverse probability of treatment
weights. For example, if it is assumed that an individual will stay on treatment for at least 2 visits, the first 2
visits  after treatment initiation by definition have a probability of staying on the treatment of 1.0 and should
thus be excluded from the weight models for those who are on treatment at the immediately previous visit. Users can
define a variable that indicates that these 2 observations are ineligible for the weight model for those who are on
treatment at the immediately previous visit and add the variable name in the argument <code>eligible_wts_1</code>. Similar
definitions are applied to <code>eligible_wts_0</code> for excluding observations when fitting the models for the inverse
probability of treatment weights for those who are not on treatment at the immediately previous visit.</p></dd>


<dt id="arg-where-var">where_var<a class="anchor" aria-label="anchor" href="#arg-where-var"></a></dt>
<dd><p>Specify the variable names that will be used to define subgroup conditions when fitting the marginal
structural model for a subgroup of individuals. Need to specify jointly with the argument <code>where_case</code>.</p></dd>


<dt id="arg-where-case">where_case<a class="anchor" aria-label="anchor" href="#arg-where-case"></a></dt>
<dd><p>Define conditions using variables specified in <code>where_var</code> when fitting a marginal structural model
for a subgroup of the individuals. For example, if <code>where_var= "age"</code>, <code>where_case = "age &gt;= 30"</code> will only fit the
marginal structural model to the subgroup of individuals. who are 30 years old or above.</p></dd>


<dt id="arg-data-dir">data_dir<a class="anchor" aria-label="anchor" href="#arg-data-dir"></a></dt>
<dd><p>Directory to save model objects in.</p></dd>


<dt id="arg-glm-function">glm_function<a class="anchor" aria-label="anchor" href="#arg-glm-function"></a></dt>
<dd><p>Specify which glm function to use for the marginal structural model from the <code>stats</code> or <code>parglm</code>
packages. The default function is the <code>glm</code> function in the <code>stats</code> package. Users can also specify <code>glm_function = "parglm"</code> such that the <code>parglm</code> function in the <code>parglm</code> package can be used for fitting generalized linear models
in parallel. The default control setting for  <code>parglm</code> is <code>nthreads = 4</code> and <code>method = "FAST"</code>, where four cores
and Fisher information are used for faster computation. Users can change the default control setting by passing the
arguments <code>nthreads</code> and <code>method</code> in the <code>parglm.control</code> function of the <code>parglm</code> package, or alternatively, by
passing a <code>control</code> argument with a list produced by <code>parglm.control(nthreads = , method = )</code>.</p></dd>


<dt id="arg-quiet">quiet<a class="anchor" aria-label="anchor" href="#arg-quiet"></a></dt>
<dd><p>Suppress the printing of progress messages and summaries of the fitted models.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to <code>glm_function</code>. This may be used to specify initial values of parameters or
arguments to <code>control</code>. See <a href="https://rdrr.io/r/stats/glm.html" class="external-link">stats::glm</a>, <a href="https://rdrr.io/pkg/parglm/man/parglm.html" class="external-link">parglm::parglm</a> and <code><a href="https://rdrr.io/pkg/parglm/man/parglm.control.html" class="external-link">parglm::parglm.control()</a></code> for more information.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Returns the result of <code><a href="trial_msm.html">trial_msm()</a></code> from the expanded data. An object of class <code>TE_msm</code> containing</p><dl><dt>model</dt>
<dd><p>a <code>glm</code> object</p></dd>

<dt>robust</dt>
<dd><p>a list containing a summary table of estimated regression coefficients and the robust covariance
matrix</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>An all-in-one analysis using a sequence of emulated target trials. This provides a simplified interface to the main
functions <code><a href="data_preparation.html">data_preparation()</a></code> and <code><a href="trial_msm.html">trial_msm()</a></code>.</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Isaac Gravestock, Li Su, Roonak Rezvani, Julia Moesch, Medical Research Council (MRC), F. Hoffmann-La Roche AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

