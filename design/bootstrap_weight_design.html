<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Bootstrap CIs design</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Bootstrap CIs design</h1>


<div id="TOC">
<ul>
<li><a href="#current-flowchart" id="toc-current-flowchart">Current
Flowchart</a></li>
<li><a href="#proposal" id="toc-proposal">Proposal</a></li>
<li><a href="#modifications-to-predict.r" id="toc-modifications-to-predict.r">Modifications to
<code>predict.R</code></a></li>
<li><a href="#design-of-function_that_calculates_bootstrap_cis" id="toc-design-of-function_that_calculates_bootstrap_cis">Design of
function_that_calculates_bootstrap_CIs</a></li>
</ul>
</div>

<div id="current-flowchart" class="section level3">
<h3>Current Flowchart</h3>
<p>This flow chart helps visualise the complete workflow.</p>
<div class="float">
<img role="img" aria-label="Flowchart" src="~/TrialEmulation/vignettes/img/trial_sequence_functions_overview_solid.png" style="width:80.0%" alt="Flowchart" />
<div class="figcaption">Flowchart</div>
</div>
</div>
<div id="proposal" class="section level3">
<h3>Proposal</h3>
<p>The bootstrap confidence intevals (CIs) construction would come at
the end of the flowchart. There is no way of having it higher up as they
require the prediction at the end to build the CIs.</p>
<p>We currently use the <code>predict()</code> method to estimate
survival probabilities or cumulative incidences for different values of
<code>assigned_treatment</code>. I propose we add a function variable
<code>ci_type</code> to specify the CIs we want to output.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  trial_pp,</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="at">newdata =</span> <span class="fu">outcome_data</span>(trial_itt)[trial_period <span class="sc">==</span> <span class="dv">1</span>, ],</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="at">predict_times =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;mrd&quot;</span>, <span class="co"># we could specify &quot;mrd&quot; for marginal risk difference</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="at">ci_type =</span> <span class="fu">c</span>(<span class="st">&quot;Nonparametric Bootstrap&quot;</span>, <span class="st">&quot;LEF bootstrap&quot;</span>, <span class="st">&quot;Robust Sandwich&quot;</span>) <span class="co"># NEW could add function variable to specify the type of CIs the user wants</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">plot</span>(preds<span class="sc">$</span>difference<span class="sc">$</span>followup_time, preds<span class="sc">$</span>difference<span class="sc">$</span>mrd_diff, </span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;l&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;Follow up&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;Marginal risk difference&quot;</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">lines</span>(preds<span class="sc">$</span>difference<span class="sc">$</span>followup_time, preds<span class="sc">$</span>difference<span class="sc">$</span><span class="st">`</span><span class="at">2.5%</span><span class="st">`</span>, <span class="at">type =</span> <span class="st">&quot;l&quot;</span>, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)  <span class="co"># preds$difference$`2.5%`, could have another $ to differentiate CI methods</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="fu">lines</span>(preds<span class="sc">$</span>difference<span class="sc">$</span>followup_time, preds<span class="sc">$</span>difference<span class="sc">$</span><span class="st">`</span><span class="at">97.5%</span><span class="st">`</span>, <span class="at">type =</span> <span class="st">&quot;l&quot;</span>, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="modifications-to-predict.r" class="section level3">
<h3>Modifications to <code>predict.R</code></h3>
<p>Currently, predict.R is the script that specifies the function
predict() above. If the command ‘type = “survival”’ is imputed, the
resulting difference in <code>preds$difference</code> is an estimate for
the estimand <span class="math inline">\(\Pr(Y_{m,k}^{\overline a_k=
\overline 1} = 0) - \Pr(Y_{m,k}^{\overline a_k= \overline 0} =
0)\)</span>. If the command ‘type = “cum_inc”’ is imputed, the
difference is the marginal risk difference estimate. In either case, we
can build confidence intervals according to the methods described in the
paper.</p>
<p>The sandwich CIs are calculated when obtaining the predictions in
<code>calculate_predictions()</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>pred_list <span class="ot">&lt;-</span> <span class="fu">calculate_predictions</span>(</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>    <span class="at">newdata =</span> newdata,</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>    <span class="at">model =</span> model,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>    <span class="at">treatment_values =</span> <span class="fu">c</span>(<span class="at">assigned_treatment_0 =</span> <span class="dv">0</span>, <span class="at">assigned_treatment_1 =</span> <span class="dv">1</span>),</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>    <span class="at">pred_fun =</span> pred_fun,</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>    <span class="at">coefs_mat =</span> coefs_mat,</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>    <span class="at">matrix_n_col =</span> <span class="fu">length</span>(predict_times)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>  )</span></code></pre></div>
<p>Denote by <span class="math inline">\(S\)</span> the sample size for
the multivariate normal sampling for the sandwich CI construction. The
variable <code>coefs_mat</code> in <code>calculate_predictions()</code>
has <span class="math inline">\(1 + S\)</span> columns. The first column
is the point estimates of the MSM coefficients from trial_msm. The S
remaining columns correspond to the <span class="math inline">\(S\)</span> coefficients generated from the
multivariate normal sampling centered at the point estimate of the
coefficients and with variance as the robust sandwich variance
matrix.</p>
<p>I don’t think we can repurpose or easily modify
<code>calculate_predictions()</code> to construct the other CIs. I can
certainly use the output, <code>pred_list$difference</code>, and the
function itself to generate the MRD in each bootstrap sample for
example. But the bootstrap CIs will likely have to be constructed in a
separate function call.</p>
<p>The end of the function script for <code>predict()</code> could look
like this for example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a> pred_list <span class="ot">&lt;-</span> <span class="fu">calculate_predictions</span>(</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>    <span class="at">newdata =</span> newdata,</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>    <span class="at">model =</span> model,</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>    <span class="at">treatment_values =</span> <span class="fu">c</span>(<span class="at">assigned_treatment_0 =</span> <span class="dv">0</span>, <span class="at">assigned_treatment_1 =</span> <span class="dv">1</span>),</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>    <span class="at">pred_fun =</span> pred_fun,</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>    <span class="at">coefs_mat =</span> coefs_mat,</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>    <span class="at">matrix_n_col =</span> <span class="fu">length</span>(predict_times)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  )</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  pred_list<span class="sc">$</span>difference <span class="ot">&lt;-</span> pred_list<span class="sc">$</span>assigned_treatment_1 <span class="sc">-</span> pred_list<span class="sc">$</span>assigned_treatment_0</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>  output <span class="ot">&lt;-</span> <span class="fu">mapply</span>(</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>    <span class="at">pred_matrix =</span> pred_list,</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>    <span class="at">col_names =</span> <span class="fu">paste0</span>(type, <span class="fu">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="st">&quot;_diff&quot;</span>)),</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>    <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>    <span class="at">FUN =</span> <span class="cf">function</span>(pred_matrix, col_names) {</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>      <span class="cf">if</span> (ci_type <span class="sc">==</span> <span class="st">&quot;sandwich&quot;</span>) {</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>        quantiles <span class="ot">&lt;-</span> <span class="fu">apply</span>(pred_matrix, <span class="dv">1</span>, quantile, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>        <span class="fu">setNames</span>(</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>          <span class="fu">data.frame</span>(predict_times, pred_matrix[, <span class="dv">1</span>], quantiles[<span class="dv">1</span>, ], quantiles[<span class="dv">2</span>, ]),</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>          <span class="fu">c</span>(<span class="st">&quot;followup_time&quot;</span>, col_names, <span class="st">&quot;2.5%&quot;</span>, <span class="st">&quot;97.5%&quot;</span>)</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>        )</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (ci_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Nonpara. bootstrap&quot;</span>, <span class="st">&quot;LEF outcome&quot;</span>, <span class="st">&quot;LEF both&quot;</span>)){</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>        bootstrap_CIs <span class="ot">&lt;-</span> <span class="fu">function_that_calculates_bootstrap_CIs</span>(trial_msm_output, ci_type, output_from_calculate_predictions, bootstrap_sample_size)</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>        <span class="fu">setNames</span>(</span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>          <span class="fu">data.frame</span>(predict_times, pred_matrix[, <span class="dv">1</span>], bootstrap_CIs[, <span class="dv">1</span>], bootstrap_CIs[, <span class="dv">2</span>]),</span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>          <span class="fu">c</span>(<span class="st">&quot;followup_time&quot;</span>, col_names, <span class="st">&quot;lower_bound&quot;</span>, <span class="st">&quot;upper_bound&quot;</span>)</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>        )</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>      }</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>      </span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>      <span class="cf">else</span> {</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>        <span class="fu">setNames</span>(<span class="fu">data.frame</span>(predict_times, pred_matrix[, <span class="dv">1</span>]), <span class="at">nm =</span> <span class="fu">c</span>(<span class="st">&quot;followup_time&quot;</span>, col_names))</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>      }</span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>    }</span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>  )</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>  </span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>  </span></code></pre></div>
</div>
<div id="design-of-function_that_calculates_bootstrap_cis" class="section level3">
<h3>Design of function_that_calculates_bootstrap_CIs</h3>
<p>In dummy codes, here are the steps of the function:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">#&#39; @param trial_msm_output output for fit_msm(), should contain all relevant information including original data, expanded data, </span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">#&#39; weight models formulae, outcome model</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#&#39; @param ci_type string or vector of strings of bootstrap CI types user wants (&quot;Nonpara. bootstrap&quot;, &quot;LEF outcome only&quot;, &quot;LEF both&quot;) </span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#&#39; (these names are subject to change)</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">#&#39; @param output_from_calculate_predictions output of calculate_predictions()$difference as the point estimate is need to build pivot CIs</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#&#39; @param bootstrap_sample_size Number of bootstrap samples</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#&#39;</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>function_that_calculates_bootstrap_CIs <span class="ot">&lt;-</span> <span class="cf">function</span>(trial_msm_output, ci_type, output_from_calculate_predictions, bootstrap_sample_size){</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a> <span class="do">##########################################################################################################################</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a> <span class="co">#  All code below needs to be changed to match variable names with function input, some of which are class type #</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a> <span class="do">##########################################################################################################################</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>  <span class="cf">if</span> (ci_type <span class="sc">!=</span> <span class="st">&#39;Nonpara. bootstrap&#39;</span>){</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>    X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(PP<span class="sc">$</span>model)</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>    e <span class="ot">&lt;-</span> PP<span class="sc">$</span>model<span class="sc">$</span>y <span class="sc">-</span> PP<span class="sc">$</span>model<span class="sc">$</span>fitted.values</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>    <span class="cf">if</span> (ci_type <span class="sc">==</span> <span class="st">&#39;LEF both&#39;</span>){</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>      X_sw_d0 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(switch_d0)</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>      e_sw_d0 <span class="ot">&lt;-</span> switch_d0<span class="sc">$</span>y <span class="sc">-</span> switch_d0<span class="sc">$</span>fitted.values</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>      </span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>      X_sw_n0 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(switch_n0)</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>      e_sw_n0 <span class="ot">&lt;-</span> switch_n0<span class="sc">$</span>y <span class="sc">-</span> switch_n0<span class="sc">$</span>fitted.values</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>      </span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>      X_sw_d1 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(switch_d1)</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>      e_sw_d1 <span class="ot">&lt;-</span> switch_d1<span class="sc">$</span>y <span class="sc">-</span> switch_d1<span class="sc">$</span>fitted.values</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>      </span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>      X_sw_n1 <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(switch_n1)</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>      e_sw_n1 <span class="ot">&lt;-</span> switch_n1<span class="sc">$</span>y <span class="sc">-</span> switch_n1<span class="sc">$</span>fitted.values</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>    </span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>    }</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>  }</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>  </span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>  <span class="co">#Step 1: for each bootstrap sample: </span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>  bootstrapped_MRDs <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">k =</span> <span class="dv">1</span><span class="sc">:</span>bootstrap_sample_size, <span class="at">.combine=</span>cbind) <span class="sc">%dopar%</span> {</span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>     </span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>    <span class="co">#Bootstrap sample with patient id as sampling unit</span></span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>    boot_idx <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">sample</span>(<span class="fu">unique</span>(triat_pp<span class="sc">@</span>outcome_data<span class="sc">$</span>id), <span class="fu">length</span>(<span class="fu">unique</span>(triat_pp<span class="sc">@</span>outcome_data<span class="sc">$</span>id)),<span class="at">replace =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>    </span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>    weights_table_boot <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">unique</span>(triat_pp<span class="sc">@</span>outcome_data<span class="sc">$</span>id)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>        <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">weight_boot =</span> <span class="fu">length</span>(boot_idx[boot_idx <span class="sc">==</span> id])) <span class="co">#bootstrap sampling weight is number of times they were sampled</span></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>    </span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>    <span class="co"># Step 2: refit/recalculate weights </span></span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>    <span class="cf">if</span> (ci_type <span class="sc">==</span> <span class="st">&#39;LEF both&#39;</span>){</span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>      <span class="co"># Calculate the weight models&#39; coefficient LEF approximates</span></span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a>      data_0 <span class="ot">&lt;-</span> <span class="fu">merge</span>(weights_table_boot, switch_d0<span class="sc">$</span>data, <span class="at">on =</span> id, <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>      data_1 <span class="ot">&lt;-</span> <span class="fu">merge</span>(weights_table_boot, switch_d1<span class="sc">$</span>data, <span class="at">on =</span> id, <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a>      </span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a>      LEF_sw_d0_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(X_sw_d0)<span class="sc">%*%</span>(data_0<span class="sc">$</span>weight_boot<span class="sc">*</span>e_sw_d0)</span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a>      LEF_sw_n0_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(X_sw_n0)<span class="sc">%*%</span>(data_0<span class="sc">$</span>weight_boot<span class="sc">*</span>e_sw_n0)</span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a>      LEF_sw_d1_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(X_sw_d1)<span class="sc">%*%</span>(data_1<span class="sc">$</span>weight_boot<span class="sc">*</span>e_sw_d1)</span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a>      LEF_sw_n1_boot <span class="ot">&lt;-</span> <span class="fu">t</span>(X_sw_n1)<span class="sc">%*%</span>(data_1<span class="sc">$</span>weight_boot<span class="sc">*</span>e_sw_n1)</span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a>      </span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a>      <span class="co">#Calculate \hat \beta(b)</span></span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a>      beta_sw_d0 <span class="ot">&lt;-</span> switch_d0<span class="sc">$</span>coefficients <span class="sc">+</span> <span class="fu">vcov</span>(switch_d0)<span class="sc">%*%</span>LEF_sw_d0_boot</span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a>      beta_sw_n0 <span class="ot">&lt;-</span> switch_n0<span class="sc">$</span>coefficients <span class="sc">+</span> <span class="fu">vcov</span>(switch_n0)<span class="sc">%*%</span>LEF_sw_n0_boot</span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a>      beta_sw_d1 <span class="ot">&lt;-</span> switch_d1<span class="sc">$</span>coefficients <span class="sc">+</span> <span class="fu">vcov</span>(switch_d1)<span class="sc">%*%</span>LEF_sw_d1_boot</span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a>      beta_sw_n1 <span class="ot">&lt;-</span> switch_n1<span class="sc">$</span>coefficients <span class="sc">+</span> <span class="fu">vcov</span>(switch_n1)<span class="sc">%*%</span>LEF_sw_n1_boot</span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a>      </span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a>      boot_design_data <span class="ot">&lt;-</span> <span class="fu">weight_func_bootstrap</span>(<span class="at">data =</span> simdata_censored, <span class="at">expanded_data =</span> switch_data, </span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a>                                        <span class="at">switch_d_cov =</span> <span class="co">#extract weight models, somewhere in trial_pp@censor</span></span>
<span id="cb4-60"><a href="#cb4-60" tabindex="-1"></a>                                        <span class="at">weight_model_d0 =</span> switch_d0, <span class="co">#extra glm objects, either in trial_PP or saved rds files</span></span>
<span id="cb4-61"><a href="#cb4-61" tabindex="-1"></a>                                        <span class="at">weight_model_n0 =</span> switch_n0,</span>
<span id="cb4-62"><a href="#cb4-62" tabindex="-1"></a>                                        <span class="at">weight_model_d1 =</span> switch_d1,</span>
<span id="cb4-63"><a href="#cb4-63" tabindex="-1"></a>                                        <span class="at">weight_model_n1 =</span> switch_n1,</span>
<span id="cb4-64"><a href="#cb4-64" tabindex="-1"></a>                                        <span class="at">new_coef_sw_d0 =</span> beta_sw_d0,</span>
<span id="cb4-65"><a href="#cb4-65" tabindex="-1"></a>                                        <span class="at">new_coef_sw_n0 =</span> beta_sw_n0,</span>
<span id="cb4-66"><a href="#cb4-66" tabindex="-1"></a>                                        <span class="at">new_coef_sw_d1 =</span> beta_sw_d1,</span>
<span id="cb4-67"><a href="#cb4-67" tabindex="-1"></a>                                        <span class="at">new_coef_sw_n1 =</span> beta_sw_n1,</span>
<span id="cb4-68"><a href="#cb4-68" tabindex="-1"></a>                                        <span class="at">boot_idx =</span> boot_idx, <span class="at">remodel =</span> <span class="cn">FALSE</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-69"><a href="#cb4-69" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-70"><a href="#cb4-70" tabindex="-1"></a>      boot_design_data <span class="ot">&lt;-</span> <span class="fu">weight_func_bootstrap</span>(<span class="at">expanded_data =</span> triat_pp<span class="sc">@</span>outcome_data, </span>
<span id="cb4-71"><a href="#cb4-71" tabindex="-1"></a>                                            <span class="at">switch_d_cov =</span> <span class="co">#extract weight models, somewhere in trial_pp@censor</span></span>
<span id="cb4-72"><a href="#cb4-72" tabindex="-1"></a>                                            <span class="at">weight_model_d0 =</span> switch_d0, <span class="co">#extra glm objects, either in trial_PP or saved rds files</span></span>
<span id="cb4-73"><a href="#cb4-73" tabindex="-1"></a>                                            <span class="at">weight_model_n0 =</span> switch_n0,</span>
<span id="cb4-74"><a href="#cb4-74" tabindex="-1"></a>                                            <span class="at">weight_model_d1 =</span> switch_d1,</span>
<span id="cb4-75"><a href="#cb4-75" tabindex="-1"></a>                                            <span class="at">weight_model_n1 =</span> switch_n1,</span>
<span id="cb4-76"><a href="#cb4-76" tabindex="-1"></a>                                            <span class="at">boot_idx =</span> boot_idx, <span class="at">remodel =</span> <span class="cn">TRUE</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-77"><a href="#cb4-77" tabindex="-1"></a>          </span>
<span id="cb4-78"><a href="#cb4-78" tabindex="-1"></a>    }</span>
<span id="cb4-79"><a href="#cb4-79" tabindex="-1"></a>      <span class="co"># STep 3. A) : refit MSM (only for nonparametric bootstrap)</span></span>
<span id="cb4-80"><a href="#cb4-80" tabindex="-1"></a>    <span class="cf">if</span>(ci_type <span class="sc">==</span> <span class="st">&#39;Nonpara. bootstrap&#39;</span>){</span>
<span id="cb4-81"><a href="#cb4-81" tabindex="-1"></a>          PP_boot <span class="ot">&lt;-</span> <span class="fu">trial_msm</span>(<span class="at">data =</span> boot_design_data,</span>
<span id="cb4-82"><a href="#cb4-82" tabindex="-1"></a>                                           <span class="at">outcome_cov =</span> model,</span>
<span id="cb4-83"><a href="#cb4-83" tabindex="-1"></a>                                           <span class="at">model_var =</span> <span class="fu">c</span>(<span class="st">&#39;assigned_treatment&#39;</span>),</span>
<span id="cb4-84"><a href="#cb4-84" tabindex="-1"></a>                                           <span class="at">glm_function =</span> <span class="st">&#39;glm&#39;</span>,</span>
<span id="cb4-85"><a href="#cb4-85" tabindex="-1"></a>                                           <span class="at">include_trial_period =</span> <span class="sc">~</span><span class="dv">1</span>, <span class="at">include_followup_time =</span> <span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb4-86"><a href="#cb4-86" tabindex="-1"></a>                                           <span class="at">use_weight=</span>T, <span class="at">use_censor=</span>T, <span class="at">quiet =</span> T, <span class="at">use_sample_weights =</span>  F)</span>
<span id="cb4-87"><a href="#cb4-87" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-88"><a href="#cb4-88" tabindex="-1"></a>          <span class="co"># Can we call fit_msm ?</span></span>
<span id="cb4-89"><a href="#cb4-89" tabindex="-1"></a>      <span class="co"># Step 3. B): recalculate MSM coefficient (for LEF)</span></span>
<span id="cb4-90"><a href="#cb4-90" tabindex="-1"></a>          LEFs <span class="ot">&lt;-</span> <span class="fu">t</span>(X)<span class="sc">%*%</span>(boot_design_data<span class="sc">$</span>weight<span class="sc">*</span>e)</span>
<span id="cb4-91"><a href="#cb4-91" tabindex="-1"></a>          LEFs[<span class="fu">is.na</span>(LEFs)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-92"><a href="#cb4-92" tabindex="-1"></a>          variance_mat <span class="ot">&lt;-</span> <span class="fu">vcov</span>(PP<span class="sc">$</span>model)</span>
<span id="cb4-93"><a href="#cb4-93" tabindex="-1"></a>          variance_mat[<span class="fu">is.na</span>(variance_mat)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-94"><a href="#cb4-94" tabindex="-1"></a>          <span class="co">#Calculate \hat \beta(b)</span></span>
<span id="cb4-95"><a href="#cb4-95" tabindex="-1"></a>          beta <span class="ot">&lt;-</span> PP<span class="sc">$</span>model<span class="sc">$</span>coefficients <span class="sc">+</span> variance_mat<span class="sc">%*%</span>LEFs</span>
<span id="cb4-96"><a href="#cb4-96" tabindex="-1"></a>          </span>
<span id="cb4-97"><a href="#cb4-97" tabindex="-1"></a>          PP_boot <span class="ot">&lt;-</span> PP</span>
<span id="cb4-98"><a href="#cb4-98" tabindex="-1"></a>          PP_boot<span class="sc">$</span>model<span class="sc">$</span>coefficients <span class="ot">&lt;-</span> beta</span>
<span id="cb4-99"><a href="#cb4-99" tabindex="-1"></a>  }</span>
<span id="cb4-100"><a href="#cb4-100" tabindex="-1"></a>      <span class="co">#step 4: get prediction in bootstrap sample</span></span>
<span id="cb4-101"><a href="#cb4-101" tabindex="-1"></a>          <span class="co"># Could reuse calculate_predictions(newdata = bootstrap_sample) ?</span></span>
<span id="cb4-102"><a href="#cb4-102" tabindex="-1"></a>          bootstrap_sample <span class="ot">&lt;-</span> expanded_data[expanded_data<span class="sc">$</span>id <span class="sc">==</span> boot_idx[<span class="dv">1</span>],]</span>
<span id="cb4-103"><a href="#cb4-103" tabindex="-1"></a>          <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(boot_idx)){</span>
<span id="cb4-104"><a href="#cb4-104" tabindex="-1"></a>            bootstrap_sample <span class="ot">&lt;-</span> <span class="fu">rbind</span>(bootstrap_sample, expanded_data[expanded_data<span class="sc">$</span>id <span class="sc">==</span> boot_idx[i],])</span>
<span id="cb4-105"><a href="#cb4-105" tabindex="-1"></a>          } <span class="co">#I feel like there could be a more efficient way of doing this.</span></span>
<span id="cb4-106"><a href="#cb4-106" tabindex="-1"></a>    </span>
<span id="cb4-107"><a href="#cb4-107" tabindex="-1"></a>          pred_list_boot <span class="ot">&lt;-</span> <span class="fu">calculate_predictions</span>(</span>
<span id="cb4-108"><a href="#cb4-108" tabindex="-1"></a>                            <span class="at">newdata =</span> bootstrap_sample,</span>
<span id="cb4-109"><a href="#cb4-109" tabindex="-1"></a>                            <span class="at">model =</span> PP_boot<span class="sc">$</span>model,</span>
<span id="cb4-110"><a href="#cb4-110" tabindex="-1"></a>                            <span class="at">treatment_values =</span> <span class="fu">c</span>(<span class="at">assigned_treatment_0 =</span> <span class="dv">0</span>, <span class="at">assigned_treatment_1 =</span> <span class="dv">1</span>),</span>
<span id="cb4-111"><a href="#cb4-111" tabindex="-1"></a>                            <span class="at">pred_fun =</span> pred_fun,</span>
<span id="cb4-112"><a href="#cb4-112" tabindex="-1"></a>                            <span class="at">coefs_mat =</span> PP_boot<span class="sc">$</span>model<span class="sc">$</span>coefficients,</span>
<span id="cb4-113"><a href="#cb4-113" tabindex="-1"></a>                            <span class="at">matrix_n_col =</span> <span class="fu">length</span>(predict_times)</span>
<span id="cb4-114"><a href="#cb4-114" tabindex="-1"></a>                          )</span>
<span id="cb4-115"><a href="#cb4-115" tabindex="-1"></a>          </span>
<span id="cb4-116"><a href="#cb4-116" tabindex="-1"></a>          pred_list_boot<span class="sc">$</span>difference</span>
<span id="cb4-117"><a href="#cb4-117" tabindex="-1"></a>          </span>
<span id="cb4-118"><a href="#cb4-118" tabindex="-1"></a>  }</span>
<span id="cb4-119"><a href="#cb4-119" tabindex="-1"></a>  <span class="co"># Step 5: generate pivot CIs</span></span>
<span id="cb4-120"><a href="#cb4-120" tabindex="-1"></a>  CI_lb <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>pred_list<span class="sc">$</span>difference <span class="sc">-</span> <span class="fu">apply</span>(bootstrapped_MRDs,</span>
<span id="cb4-121"><a href="#cb4-121" tabindex="-1"></a>                                                           <span class="dv">1</span>,</span>
<span id="cb4-122"><a href="#cb4-122" tabindex="-1"></a>                                                           quantile,</span>
<span id="cb4-123"><a href="#cb4-123" tabindex="-1"></a>                                                           <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.975</span>))</span>
<span id="cb4-124"><a href="#cb4-124" tabindex="-1"></a>  CI_ub <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>pred_list<span class="sc">$</span>difference <span class="sc">-</span> <span class="fu">apply</span>(bootstrapped_MRDs,</span>
<span id="cb4-125"><a href="#cb4-125" tabindex="-1"></a>                                                           <span class="dv">1</span>,</span>
<span id="cb4-126"><a href="#cb4-126" tabindex="-1"></a>                                                           quantile,</span>
<span id="cb4-127"><a href="#cb4-127" tabindex="-1"></a>                                                           <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>))</span>
<span id="cb4-128"><a href="#cb4-128" tabindex="-1"></a>  </span>
<span id="cb4-129"><a href="#cb4-129" tabindex="-1"></a>  <span class="co">#Step 6: Add CIs to the output data from the end of predict()</span></span>
<span id="cb4-130"><a href="#cb4-130" tabindex="-1"></a>  </span>
<span id="cb4-131"><a href="#cb4-131" tabindex="-1"></a>  <span class="fu">cbind</span>(CI_lb,CI_ub)</span>
<span id="cb4-132"><a href="#cb4-132" tabindex="-1"></a>}</span></code></pre></div>
<p>For <code>weight_func_bootstrap()</code>: this is mainly a
modification based on <code>weight_func()</code> in
<code>data_utils.R</code>. The main purpose of this function is to refit
the weight models on a new data set (i.e. bootstrap sample) or
recalculate weights based on a new set of coefficients (for LEF
bootstrap CIs). It also takes some code from
<code>data_expansion.R</code>. The input is the expanded data and a
bootstrap sample vector of IDs and the returned output is the same
expanded data with new weights.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>weight_func_bootstrap <span class="ot">&lt;-</span> <span class="cf">function</span>(expanded_data,</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>                                  <span class="at">use_switch_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>                                  <span class="at">use_censor_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>                                  <span class="at">switch_n_cov =</span> <span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>                                  <span class="at">switch_d_cov =</span> <span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>                                  <span class="at">eligible_wts_0 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>                                  <span class="at">eligible_wts_1 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>                                  <span class="at">cense =</span> <span class="cn">NA</span>,</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>                                  <span class="at">pool_cense_n =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>                                  <span class="at">pool_cense_d =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>                                  <span class="at">cense_d_cov =</span> <span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>                                  <span class="at">cense_n_cov =</span> <span class="sc">~</span><span class="dv">1</span>,</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>                                  <span class="at">save_weight_models =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>                                  <span class="at">data_dir =</span> <span class="cn">NA</span>,</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>                                  <span class="at">quiet =</span> <span class="cn">FALSE</span>,</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>                                  <span class="at">glm_function =</span> <span class="st">&quot;glm&quot;</span>,</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>                                  <span class="at">weight_model_d0 =</span> switch_d0,</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>                                  <span class="at">weight_model_n0 =</span> switch_n0,</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>                                  <span class="at">weight_model_d1 =</span> switch_d1,</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>                                  <span class="at">weight_model_n1 =</span> switch_n1,</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>                                  <span class="at">cense_model_d =</span> <span class="cn">NA</span>,</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>                                  <span class="at">cense_model_n =</span> <span class="cn">NA</span>,</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>                                  <span class="at">cense_model_d0 =</span> cense_d0,</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>                                  <span class="at">cense_model_n0 =</span> cense_n0,</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>                                  <span class="at">cense_model_d1 =</span> cense_d1,</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>                                  <span class="at">cense_model_n1 =</span> cense_n1,</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>                                  <span class="at">remodel =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>                                  <span class="at">new_coef_sw_d0 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>                                  <span class="at">new_coef_sw_n0 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>                                  <span class="at">new_coef_sw_d1 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>                                  <span class="at">new_coef_sw_n1 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>                                  <span class="at">new_coef_c_d0 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>                                  <span class="at">new_coef_c_n0 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>                                  <span class="at">new_coef_c_d1 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>                                  <span class="at">new_coef_c_n1 =</span> <span class="cn">NA</span>,</span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>                                  <span class="at">new_coef_c_d =</span> <span class="cn">NA</span>,</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a>                                  <span class="at">new_coef_c_n =</span> <span class="cn">NA</span>,</span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a>                                  <span class="at">boot_idx =</span> <span class="cn">NA</span>,</span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a>                                  ...) {</span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a><span class="co"># Step 1: extra data from weight model glm objects</span></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>....</span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>  <span class="co"># Step 2: Filter by bootstrapped IDs. Create new &#39;weight_boot&#39; variable in weight model datas which is bootstrap resampling weight</span></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a> </span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a>  ....</span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>  </span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>  sw_data <span class="co"># extracted from weight model glm objects  </span></span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a>  </span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>  </span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a>  <span class="co"># Step 3: Weight recalculation</span></span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a>  </span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a>  <span class="do">## IF remodel == TRUE, we re-fit IP weight models (for nonparametric bootstrap, LEF outcome)</span></span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a>  <span class="do">## Re-use the same weight model formulae</span></span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a>  switch_n_cov</span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a>  switch_d_cov </span>
<span id="cb5-55"><a href="#cb5-55" tabindex="-1"></a>  cense_d_cov</span>
<span id="cb5-56"><a href="#cb5-56" tabindex="-1"></a>  cense_n_cov</span>
<span id="cb5-57"><a href="#cb5-57" tabindex="-1"></a>  </span>
<span id="cb5-58"><a href="#cb5-58" tabindex="-1"></a>  <span class="do">## ELSE: For LEF both, we recalculate the weights using the new weight model coefficients </span></span>
<span id="cb5-59"><a href="#cb5-59" tabindex="-1"></a>  new_coef_sw_d0</span>
<span id="cb5-60"><a href="#cb5-60" tabindex="-1"></a>  ...</span>
<span id="cb5-61"><a href="#cb5-61" tabindex="-1"></a>  <span class="co">#Example: </span></span>
<span id="cb5-62"><a href="#cb5-62" tabindex="-1"></a>  <span class="cf">if</span>(remodel <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb5-63"><a href="#cb5-63" tabindex="-1"></a>      switch_d_cov <span class="ot">&lt;-</span> <span class="fu">update.formula</span>(switch_d_cov, treatment <span class="sc">~</span> .)</span>
<span id="cb5-64"><a href="#cb5-64" tabindex="-1"></a>      switch_n_cov <span class="ot">&lt;-</span> <span class="fu">update.formula</span>(switch_n_cov, treatment <span class="sc">~</span> .)</span>
<span id="cb5-65"><a href="#cb5-65" tabindex="-1"></a>      </span>
<span id="cb5-66"><a href="#cb5-66" tabindex="-1"></a>      switch_results <span class="ot">&lt;-</span> <span class="fu">fit_switch_weights</span>(</span>
<span id="cb5-67"><a href="#cb5-67" tabindex="-1"></a>        <span class="at">switch_d_cov =</span> switch_d_cov,</span>
<span id="cb5-68"><a href="#cb5-68" tabindex="-1"></a>        <span class="at">switch_n_cov =</span> switch_n_cov,</span>
<span id="cb5-69"><a href="#cb5-69" tabindex="-1"></a>        <span class="at">weights =</span> weight_boot, <span class="do">## this is important addition to the weight fitting functions. By including bootstrap resampling weights we make sure the fit is  </span></span>
<span id="cb5-70"><a href="#cb5-70" tabindex="-1"></a>        <span class="co"># on bootstrapped data. This weighting in the glm accounts for patients being sampled with replacement</span></span>
<span id="cb5-71"><a href="#cb5-71" tabindex="-1"></a>        <span class="at">eligible_wts_0 =</span> eligible_wts_0,</span>
<span id="cb5-72"><a href="#cb5-72" tabindex="-1"></a>        <span class="at">eligible_wts_1 =</span> eligible_wts_1,</span>
<span id="cb5-73"><a href="#cb5-73" tabindex="-1"></a>        <span class="at">sw_data =</span> sw_data,</span>
<span id="cb5-74"><a href="#cb5-74" tabindex="-1"></a>        <span class="at">quiet =</span> quiet,</span>
<span id="cb5-75"><a href="#cb5-75" tabindex="-1"></a>        <span class="at">save_dir =</span> data_dir,</span>
<span id="cb5-76"><a href="#cb5-76" tabindex="-1"></a>        <span class="at">save_weight_models =</span> save_weight_models,</span>
<span id="cb5-77"><a href="#cb5-77" tabindex="-1"></a>        <span class="at">glm_function =</span> glm_function,</span>
<span id="cb5-78"><a href="#cb5-78" tabindex="-1"></a>        ...</span>
<span id="cb5-79"><a href="#cb5-79" tabindex="-1"></a>      )</span>
<span id="cb5-80"><a href="#cb5-80" tabindex="-1"></a>      sw_data <span class="ot">&lt;-</span> switch_results<span class="sc">$</span>sw_data</span>
<span id="cb5-81"><a href="#cb5-81" tabindex="-1"></a>      switch_models <span class="ot">&lt;-</span> switch_results<span class="sc">$</span>switch_models</span>
<span id="cb5-82"><a href="#cb5-82" tabindex="-1"></a>      <span class="fu">rm</span>(switch_results)</span>
<span id="cb5-83"><a href="#cb5-83" tabindex="-1"></a>  } <span class="cf">else</span>{ <span class="co"># For LEF both, recalculate weights with new coefficients</span></span>
<span id="cb5-84"><a href="#cb5-84" tabindex="-1"></a>      weight_model_d0<span class="sc">$</span>coefficients <span class="ot">&lt;-</span> new_coef_sw_d0</span>
<span id="cb5-85"><a href="#cb5-85" tabindex="-1"></a>      weight_model_n0<span class="sc">$</span>coefficients <span class="ot">&lt;-</span> new_coef_sw_n0</span>
<span id="cb5-86"><a href="#cb5-86" tabindex="-1"></a>      weight_model_d1<span class="sc">$</span>coefficients <span class="ot">&lt;-</span> new_coef_sw_d1</span>
<span id="cb5-87"><a href="#cb5-87" tabindex="-1"></a>      weight_model_n1<span class="sc">$</span>coefficients <span class="ot">&lt;-</span> new_coef_sw_n1</span>
<span id="cb5-88"><a href="#cb5-88" tabindex="-1"></a>      </span>
<span id="cb5-89"><a href="#cb5-89" tabindex="-1"></a>      switch_d0 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">p0_d =</span> <span class="fu">predict.glm</span>(weight_model_d0, weight_model_d0_data, <span class="at">type =</span> <span class="st">&#39;response&#39;</span> ), </span>
<span id="cb5-90"><a href="#cb5-90" tabindex="-1"></a>                         weight_model_d0_data[, <span class="fu">c</span>(<span class="st">&quot;eligible0&quot;</span>, <span class="st">&quot;id&quot;</span>, <span class="st">&quot;period&quot;</span>)])</span>
<span id="cb5-91"><a href="#cb5-91" tabindex="-1"></a>      </span>
<span id="cb5-92"><a href="#cb5-92" tabindex="-1"></a>      switch_n0 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">p0_n =</span> <span class="fu">predict.glm</span>(weight_model_n0, weight_model_n0_data, <span class="at">type =</span> <span class="st">&#39;response&#39;</span> ),</span>
<span id="cb5-93"><a href="#cb5-93" tabindex="-1"></a>                         weight_model_n0_data[, <span class="fu">c</span>(<span class="st">&quot;eligible0&quot;</span>, <span class="st">&quot;id&quot;</span>, <span class="st">&quot;period&quot;</span>)])</span>
<span id="cb5-94"><a href="#cb5-94" tabindex="-1"></a>      </span>
<span id="cb5-95"><a href="#cb5-95" tabindex="-1"></a>      switch_d1 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">p1_d =</span> <span class="fu">predict.glm</span>(weight_model_d1, weight_model_d1_data, <span class="at">type =</span> <span class="st">&#39;response&#39;</span> ), </span>
<span id="cb5-96"><a href="#cb5-96" tabindex="-1"></a>                         weight_model_d1_data[, <span class="fu">c</span>(<span class="st">&quot;eligible1&quot;</span>, <span class="st">&quot;id&quot;</span>, <span class="st">&quot;period&quot;</span>)])</span>
<span id="cb5-97"><a href="#cb5-97" tabindex="-1"></a>      </span>
<span id="cb5-98"><a href="#cb5-98" tabindex="-1"></a>      switch_n1 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">p1_n =</span> <span class="fu">predict.glm</span>(weight_model_n1, weight_model_n1_data, <span class="at">type =</span> <span class="st">&#39;response&#39;</span> ),</span>
<span id="cb5-99"><a href="#cb5-99" tabindex="-1"></a>                         weight_model_n1_data[, <span class="fu">c</span>(<span class="st">&quot;eligible1&quot;</span>, <span class="st">&quot;id&quot;</span>, <span class="st">&quot;period&quot;</span>)])</span>
<span id="cb5-100"><a href="#cb5-100" tabindex="-1"></a>      </span>
<span id="cb5-101"><a href="#cb5-101" tabindex="-1"></a>      switch_0 <span class="ot">&lt;-</span> switch_d0[switch_n0, on <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb5-102"><a href="#cb5-102" tabindex="-1"></a>        <span class="at">id =</span> id, <span class="at">period =</span> period,</span>
<span id="cb5-103"><a href="#cb5-103" tabindex="-1"></a>        <span class="at">eligible0 =</span> eligible0</span>
<span id="cb5-104"><a href="#cb5-104" tabindex="-1"></a>      )]</span>
<span id="cb5-105"><a href="#cb5-105" tabindex="-1"></a>      switch_1 <span class="ot">&lt;-</span> switch_d1[switch_n1, on <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb5-106"><a href="#cb5-106" tabindex="-1"></a>        <span class="at">id =</span> id, <span class="at">period =</span> period,</span>
<span id="cb5-107"><a href="#cb5-107" tabindex="-1"></a>        <span class="at">eligible1 =</span> eligible1</span>
<span id="cb5-108"><a href="#cb5-108" tabindex="-1"></a>      )]</span>
<span id="cb5-109"><a href="#cb5-109" tabindex="-1"></a>      </span>
<span id="cb5-110"><a href="#cb5-110" tabindex="-1"></a>      <span class="fu">rm</span>(switch_d0, switch_d1, switch_n0, switch_n1)</span>
<span id="cb5-111"><a href="#cb5-111" tabindex="-1"></a>      </span>
<span id="cb5-112"><a href="#cb5-112" tabindex="-1"></a>      sw_data <span class="ot">&lt;-</span> <span class="fu">merge.data.table</span>(sw_data, switch_0[, <span class="sc">-</span><span class="fu">c</span>(<span class="st">&quot;eligible0&quot;</span>)], <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;period&quot;</span>), <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-113"><a href="#cb5-113" tabindex="-1"></a>      sw_data <span class="ot">&lt;-</span> <span class="fu">merge.data.table</span>(sw_data, switch_1[, <span class="sc">-</span><span class="fu">c</span>(<span class="st">&quot;eligible1&quot;</span>)], <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;period&quot;</span>), <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-114"><a href="#cb5-114" tabindex="-1"></a>      </span>
<span id="cb5-115"><a href="#cb5-115" tabindex="-1"></a>      <span class="fu">rm</span>(switch_1, switch_0)</span>
<span id="cb5-116"><a href="#cb5-116" tabindex="-1"></a>  }</span>
<span id="cb5-117"><a href="#cb5-117" tabindex="-1"></a>  </span>
<span id="cb5-118"><a href="#cb5-118" tabindex="-1"></a> <span class="co"># Step 4: Combine predicted values from weight models and calculate IP weights </span></span>
<span id="cb5-119"><a href="#cb5-119" tabindex="-1"></a></span>
<span id="cb5-120"><a href="#cb5-120" tabindex="-1"></a>  ...</span>
<span id="cb5-121"><a href="#cb5-121" tabindex="-1"></a>  </span>
<span id="cb5-122"><a href="#cb5-122" tabindex="-1"></a>  <span class="co">#Most of this code is taken from &#39;data_expansion&#39; and &#39;data_preparation&#39; </span></span>
<span id="cb5-123"><a href="#cb5-123" tabindex="-1"></a>  </span>
<span id="cb5-124"><a href="#cb5-124" tabindex="-1"></a>  sw_data[, wt <span class="sc">:=</span> wt <span class="sc">*</span> wtC]</span>
<span id="cb5-125"><a href="#cb5-125" tabindex="-1"></a>  </span>
<span id="cb5-126"><a href="#cb5-126" tabindex="-1"></a>  censor_models <span class="ot">&lt;-</span> censor_models[<span class="fu">intersect</span>(</span>
<span id="cb5-127"><a href="#cb5-127" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">&quot;cens_pool_d&quot;</span>, <span class="st">&quot;cens_d0&quot;</span>, <span class="st">&quot;cens_n0&quot;</span>, <span class="st">&quot;cens_d1&quot;</span>, <span class="st">&quot;cens_n1&quot;</span>, <span class="st">&quot;cens_pool_n&quot;</span>),</span>
<span id="cb5-128"><a href="#cb5-128" tabindex="-1"></a>    <span class="fu">names</span>(censor_models)</span>
<span id="cb5-129"><a href="#cb5-129" tabindex="-1"></a>  )]</span>
<span id="cb5-130"><a href="#cb5-130" tabindex="-1"></a>  </span>
<span id="cb5-131"><a href="#cb5-131" tabindex="-1"></a>  sw_data[, first <span class="sc">:=</span> <span class="sc">!</span><span class="fu">duplicated</span>(sw_data[,id])]</span>
<span id="cb5-132"><a href="#cb5-132" tabindex="-1"></a>  sw_data <span class="ot">&lt;-</span> sw_data[<span class="sc">!</span><span class="fu">is.na</span>(wt)]</span>
<span id="cb5-133"><a href="#cb5-133" tabindex="-1"></a>  temp_data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb5-134"><a href="#cb5-134" tabindex="-1"></a>    <span class="at">id =</span> sw_data[, id],</span>
<span id="cb5-135"><a href="#cb5-135" tabindex="-1"></a>    <span class="at">period =</span> sw_data[, period]</span>
<span id="cb5-136"><a href="#cb5-136" tabindex="-1"></a>  )</span>
<span id="cb5-137"><a href="#cb5-137" tabindex="-1"></a>  temp_data[, wtprod <span class="sc">:=</span> <span class="fl">1.0</span>, by <span class="ot">=</span> id]</span>
<span id="cb5-138"><a href="#cb5-138" tabindex="-1"></a>  <span class="co">#[, elgcount := 0.0, by = id][, expand := 0.0, by = id]</span></span>
<span id="cb5-139"><a href="#cb5-139" tabindex="-1"></a>  <span class="co">#temp_data[, treat := 0.0, by = id][, dosesum := 0.0, by = id]</span></span>
<span id="cb5-140"><a href="#cb5-140" tabindex="-1"></a>  </span>
<span id="cb5-141"><a href="#cb5-141" tabindex="-1"></a>  sw_data[first <span class="sc">==</span> <span class="cn">TRUE</span>, weight0 <span class="sc">:=</span> <span class="fl">1.0</span>]</span>
<span id="cb5-142"><a href="#cb5-142" tabindex="-1"></a>  sw_data[, weight0 <span class="sc">:=</span> <span class="fu">cumprod</span>(wt), by <span class="ot">=</span> id]</span>
<span id="cb5-143"><a href="#cb5-143" tabindex="-1"></a>  temp_data[, wtprod <span class="sc">:=</span> sw_data[, weight0]]</span>
<span id="cb5-144"><a href="#cb5-144" tabindex="-1"></a>  <span class="co">#temp_data[, treat := data[, A]]</span></span>
<span id="cb5-145"><a href="#cb5-145" tabindex="-1"></a>  <span class="co">#temp_data[, dosesum := data[, CAp]]</span></span>
<span id="cb5-146"><a href="#cb5-146" tabindex="-1"></a>  <span class="co">#temp_data[, elgcount := data[, eligible]]</span></span>
<span id="cb5-147"><a href="#cb5-147" tabindex="-1"></a>  <span class="co">#temp_data[data[, eligible] == 1, init := data[eligible == 1, A]]</span></span>
<span id="cb5-148"><a href="#cb5-148" tabindex="-1"></a>  <span class="co">#temp_data[, init_shift := shift(data[, A])]</span></span>
<span id="cb5-149"><a href="#cb5-149" tabindex="-1"></a>  <span class="co">#temp_data[data[, eligible] == 0, init := init_shift, by = id]</span></span>
<span id="cb5-150"><a href="#cb5-150" tabindex="-1"></a>  <span class="co">#temp_data[, init_shift := NULL]</span></span>
<span id="cb5-151"><a href="#cb5-151" tabindex="-1"></a>  </span>
<span id="cb5-152"><a href="#cb5-152" tabindex="-1"></a>  expand_index <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">seq_len</span>(<span class="fu">nrow</span>(sw_data)), sw_data[, period] <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb5-153"><a href="#cb5-153" tabindex="-1"></a>  </span>
<span id="cb5-154"><a href="#cb5-154" tabindex="-1"></a>  <span class="fu">quiet_msg</span>(quiet, <span class="st">&quot;Adding new weights to expanded data&quot;</span>)</span>
<span id="cb5-155"><a href="#cb5-155" tabindex="-1"></a>  </span>
<span id="cb5-156"><a href="#cb5-156" tabindex="-1"></a>  <span class="do">### new_data only contains ID, trial_period, followup_time adn the new IP weights</span></span>
<span id="cb5-157"><a href="#cb5-157" tabindex="-1"></a>  new_data <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">id =</span> sw_data[expand_index, id])</span>
<span id="cb5-158"><a href="#cb5-158" tabindex="-1"></a>  new_data[, period_new <span class="sc">:=</span> sw_data[expand_index, period]]</span>
<span id="cb5-159"><a href="#cb5-159" tabindex="-1"></a>  <span class="co">#new_data[, cumA_new := data[expand_index, CAp]]</span></span>
<span id="cb5-160"><a href="#cb5-160" tabindex="-1"></a>  <span class="co">#new_data[, treatment_new := data[expand_index, A]]</span></span>
<span id="cb5-161"><a href="#cb5-161" tabindex="-1"></a>  </span>
<span id="cb5-162"><a href="#cb5-162" tabindex="-1"></a>  <span class="co">#new_data[, outcome_new := data[expand_index, Y]]</span></span>
<span id="cb5-163"><a href="#cb5-163" tabindex="-1"></a>  new_data[, weight0 <span class="sc">:=</span> sw_data[expand_index, weight0]]</span>
<span id="cb5-164"><a href="#cb5-164" tabindex="-1"></a>  new_data[, trial_period <span class="sc">:=</span> <span class="fu">trial_period_func</span>(sw_data)]</span>
<span id="cb5-165"><a href="#cb5-165" tabindex="-1"></a>  new_data[, index <span class="sc">:=</span> <span class="fu">seq_len</span>(.N)]</span>
<span id="cb5-166"><a href="#cb5-166" tabindex="-1"></a>  </span>
<span id="cb5-167"><a href="#cb5-167" tabindex="-1"></a>  new_data <span class="ot">&lt;-</span> new_data[temp_data, on <span class="ot">=</span> <span class="fu">list</span>(<span class="at">id =</span> id, <span class="at">trial_period =</span> period)]</span>
<span id="cb5-168"><a href="#cb5-168" tabindex="-1"></a>  <span class="fu">setorder</span>(new_data, index)</span>
<span id="cb5-169"><a href="#cb5-169" tabindex="-1"></a>  new_data[, followup_time <span class="sc">:=</span> period_new <span class="sc">-</span> trial_period]</span>
<span id="cb5-170"><a href="#cb5-170" tabindex="-1"></a>  new_data[, weight <span class="sc">:=</span> (weight0 <span class="sc">/</span> wtprod)]</span>
<span id="cb5-171"><a href="#cb5-171" tabindex="-1"></a>  </span>
<span id="cb5-172"><a href="#cb5-172" tabindex="-1"></a>  <span class="do">#### New data is merged with existing expanded data to add the new weights </span></span>
<span id="cb5-173"><a href="#cb5-173" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(boot_idx)){</span>
<span id="cb5-174"><a href="#cb5-174" tabindex="-1"></a>  output_data <span class="ot">&lt;-</span> new_data[expanded_data, on <span class="ot">=</span> <span class="fu">list</span>( <span class="at">id =</span> id, <span class="at">trial_period =</span> trial_period, </span>
<span id="cb5-175"><a href="#cb5-175" tabindex="-1"></a>                                                    <span class="at">followup_time =</span> followup_time)] <span class="sc">%&gt;%</span></span>
<span id="cb5-176"><a href="#cb5-176" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">names</span>(expanded_data)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-177"><a href="#cb5-177" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-178"><a href="#cb5-178" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">weight_boot =</span> <span class="fu">length</span>(boot_idx[boot_idx <span class="sc">==</span> id]),</span>
<span id="cb5-179"><a href="#cb5-179" tabindex="-1"></a>                  <span class="at">weight =</span> <span class="fu">ifelse</span>(weight_boot <span class="sc">!=</span><span class="dv">0</span>,weight<span class="sc">*</span>weight_boot,<span class="dv">0</span>))</span>
<span id="cb5-180"><a href="#cb5-180" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-181"><a href="#cb5-181" tabindex="-1"></a>    output_data <span class="ot">&lt;-</span> new_data[expanded_data, on <span class="ot">=</span> <span class="fu">list</span>( <span class="at">id =</span> id, <span class="at">trial_period =</span> trial_period, </span>
<span id="cb5-182"><a href="#cb5-182" tabindex="-1"></a>                                                    <span class="at">followup_time =</span> followup_time)] <span class="sc">%&gt;%</span></span>
<span id="cb5-183"><a href="#cb5-183" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">names</span>(expanded_data))</span>
<span id="cb5-184"><a href="#cb5-184" tabindex="-1"></a>  }</span>
<span id="cb5-185"><a href="#cb5-185" tabindex="-1"></a><span class="co"># Output</span></span>
<span id="cb5-186"><a href="#cb5-186" tabindex="-1"></a>  output_data </span>
<span id="cb5-187"><a href="#cb5-187" tabindex="-1"></a>}</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
